# Enhanced Docker Compose file for WhatsApp Multi-Session with MySQL
# Usage: 
#   1. Copy .env.docker.mysql to .env
#   2. Run: docker-compose -f docker-compose.yml -f docker-compose.mysql.enhanced.yml up -d

version: '3.8'

services:
  whatsapp-multi-session:
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      # Database configuration
      - DATABASE_TYPE=mysql
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=${MYSQL_USER:-whatsapp_user}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-your_secure_mysql_password_here}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-whatsapp_multi_session}
      
      # Logging configuration
      - ENABLE_LOGGING=${ENABLE_LOGGING:-true}
      - ENABLE_DATABASE_LOG=${ENABLE_DATABASE_LOG:-true}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      
      # Performance settings
      - DB_MAX_OPEN_CONNS=${DB_MAX_OPEN_CONNS:-25}
      - DB_MAX_IDLE_CONNS=${DB_MAX_IDLE_CONNS:-5}
      - DB_CONN_MAX_LIFETIME=${DB_CONN_MAX_LIFETIME:-300}
    
    # Health check for the application
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-1024M}
          cpus: ${CPU_LIMIT:-2.0}
        reservations:
          memory: 256M
          cpus: 0.5

  mysql:
    image: mysql:8.0
    container_name: whatsapp-mysql
    restart: unless-stopped
    environment:
      # Root user
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-very_secure_root_password_123}
      
      # Application database and user
      - MYSQL_DATABASE=${MYSQL_DATABASE:-whatsapp_multi_session}
      - MYSQL_USER=${MYSQL_USER:-whatsapp_user}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-your_secure_mysql_password_here}
      
      # Character set configuration
      - MYSQL_CHARACTER_SET_SERVER=utf8mb4
      - MYSQL_COLLATION_SERVER=utf8mb4_unicode_ci
      
      # Performance settings
      - MYSQL_INNODB_BUFFER_POOL_SIZE=${MYSQL_INNODB_BUFFER_POOL_SIZE:-256M}
    
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    
    volumes:
      - mysql-data:/var/lib/mysql
      - mysql-logs:/var/log/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d:ro
      # Configuration override
      - ./mysql-config:/etc/mysql/conf.d:ro
    
    networks:
      - whatsapp-network
    
    # MySQL server configuration
    command: 
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --innodb-buffer-pool-size=${MYSQL_INNODB_BUFFER_POOL_SIZE:-256M}
      - --max-connections=${MYSQL_MAX_CONNECTIONS:-200}
      - --sql_mode=STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
      - --log-bin=mysql-bin
      - --expire-logs-days=7
      - --slow-query-log=1
      - --slow-query-log-file=/var/log/mysql/slow.log
      - --long-query-time=2
    
    # Health check with authentication
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${MYSQL_USER:-whatsapp_user}", "-p${MYSQL_PASSWORD:-your_secure_mysql_password_here}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    
    # Resource limits for MySQL
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: 1.0
        reservations:
          memory: 256M
          cpus: 0.5

  # Optional: MySQL Admin Interface (phpMyAdmin)
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: whatsapp-phpmyadmin
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      - PMA_HOST=mysql
      - PMA_PORT=3306
      - PMA_USER=${MYSQL_USER:-whatsapp_user}
      - PMA_PASSWORD=${MYSQL_PASSWORD:-your_secure_mysql_password_here}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-very_secure_root_password_123}
      - UPLOAD_LIMIT=50M
    ports:
      - "8081:80"
    networks:
      - whatsapp-network
    profiles:
      - admin  # Only start with: docker-compose --profile admin up

  # Optional: Redis for session storage
  redis:
    image: redis:7-alpine
    container_name: whatsapp-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    networks:
      - whatsapp-network
    profiles:
      - redis  # Only start with: docker-compose --profile redis up
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Optional: Prometheus for monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: whatsapp-prometheus
    restart: unless-stopped
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - whatsapp-network
    profiles:
      - monitoring  # Only start with: docker-compose --profile monitoring up

  # Optional: Grafana for dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: whatsapp-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - whatsapp-network
    profiles:
      - monitoring

volumes:
  mysql-data:
    driver: local
  mysql-logs:
    driver: local
  redis-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local

networks:
  whatsapp-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16