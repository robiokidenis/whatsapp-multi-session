version: '3.8'

# Docker Volumes Configuration
# This configuration uses Docker named volumes instead of bind mounts
# Benefits:
# - Better performance
# - Managed by Docker
# - Better permissions handling
# - Data persists even if local directories are deleted
# - More portable across systems
#
# Usage: docker-compose -f docker-compose.yml -f docker-compose.volumes.yml up -d

services:
  whatsapp-multi-session:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whatsapp-multi-session
    restart: unless-stopped
    user: "1001:1001"  # Run as www user (UID:GID 1001:1001)
    ports:
      - "${PORT:-8080}:8080"
    env_file:
      - .env
    environment:
      # Application Configuration
      - PORT=${PORT:-8080}
      - JWT_SECRET=${JWT_SECRET}
      - GIN_MODE=${GIN_MODE:-release}

      # MySQL Database Configuration
      - MYSQL_HOST=${MYSQL_HOST:-mysql}
      - MYSQL_PORT=${MYSQL_PORT:-3306}
      - MYSQL_USER=${MYSQL_USER:-root}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-waGo}
      - WHATSAPP_DB_PATH=/app/database/sessions.db

      # Default Admin User
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}

      # Application Settings
      - SESSION_TIMEOUT=${SESSION_TIMEOUT:-24h}
      - MAX_SESSIONS=${MAX_SESSIONS:-10}
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # WhatsApp Configuration
      - AUTO_CONNECT=${AUTO_CONNECT:-true}

      # Security Settings
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-*}
      - RATE_LIMIT=${RATE_LIMIT:-100}

    volumes:
      # WhatsApp database - Docker volume (bind mount not needed)
      - whatsapp-database:/app/database

      # Application logs - Docker volume
      - whatsapp-logs:/app/logs

      # Session data - Docker volume
      - whatsapp-data:/app/data

      # Optional: Custom configuration (if you need to provide config files)
      # If you don't need custom config, comment this out or use a volume
      - whatsapp-config:/app/config:ro

    networks:
      - whatsapp-network

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # MySQL Service with Docker volume
  mysql:
    image: mysql:8.0
    container_name: whatsapp-mysql
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-changeme}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-waGo}
      - MYSQL_USER=${MYSQL_USER:-whatsapp_user}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-changeme}
    volumes:
      # MySQL data in Docker volume - persists across container lifecycle
      - mysql-data:/var/lib/mysql

      # Optional: MySQL init scripts
      # - ./mysql-init:/docker-entrypoint-initdb.d:ro
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    networks:
      - whatsapp-network

    # Health check
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
      interval: 30s

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  whatsapp-network:
    driver: bridge
    name: whatsapp-network

# All data is stored in Docker volumes - no local directory mounting needed!
volumes:
  # WhatsApp session database (SQLite)
  whatsapp-database:
    driver: local
    name: whatsapp-database

  # Application logs
  whatsapp-logs:
    driver: local
    name: whatsapp-logs

  # Session data
  whatsapp-data:
    driver: local
    name: whatsapp-data

  # Configuration (if needed)
  whatsapp-config:
    driver: local
    name: whatsapp-config

  # MySQL database (session metadata, users, etc.)
  mysql-data:
    driver: local
    name: whatsapp-mysql-data
