
services:
  whatsapp-multi-session:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whatsapp-multi-session
    restart: unless-stopped
    ports:
      - "${PORT:-8080}:8080"
    environment:
      # Application Configuration
      - PORT=${PORT:-8080}
      - JWT_SECRET=${JWT_SECRET}
      - GIN_MODE=${GIN_MODE:-release}
      
      # Database Configuration
      - DATABASE_PATH=${DATABASE_PATH}
      
      # Default Admin User
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      
      # Application Settings
      - SESSION_TIMEOUT=${SESSION_TIMEOUT:-24h}
      - MAX_SESSIONS=${MAX_SESSIONS:-10}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      
      # WhatsApp Configuration
      - WHATSAPP_DB_PATH=${WHATSAPP_DB_PATH}
      - AUTO_CONNECT=${AUTO_CONNECT:-true}
      
      # Security Settings
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-*}
      - RATE_LIMIT=${RATE_LIMIT:-100}
      
    volumes:
      # Database storage - maps to local whatsapp directory
      - ${DATA_DIR:-./whatsapp}:/app/data
      
      # WhatsApp session storage
      - ${WHATSAPP_DIR:-./whatsapp/sessions}:/app/sessions
      
      # Application logs
      - ${LOGS_DIR:-./whatsapp/logs}:/app/logs
      
      # Optional: Custom configuration
      - ${CONFIG_DIR:-./config}:/app/config:ro
      
    networks:
      - whatsapp-network
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  whatsapp-network:
    driver: bridge
    name: whatsapp-network

volumes:
  whatsapp-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_DIR:-./whatsapp}
  
  whatsapp-sessions:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${WHATSAPP_DIR:-./whatsapp/sessions}
      
  whatsapp-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LOGS_DIR:-./whatsapp/logs}