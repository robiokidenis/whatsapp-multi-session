
services:
  whatsapp-multi-session:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whatsapp-multi-session
    restart: unless-stopped
    ports:
      - "${PORT:-8080}:8080"
    env_file:
      - .env
    environment:
      # Application Configuration
      - PORT=${PORT:-8080}
      - JWT_SECRET=${JWT_SECRET}
      - GIN_MODE=${GIN_MODE:-release}
      
      # Database Configuration
      - DATABASE_TYPE=${DATABASE_TYPE:-sqlite}
      - DATABASE_PATH=${DATABASE_PATH}
      - MYSQL_HOST=${MYSQL_HOST:-mysql}
      - MYSQL_PORT=${MYSQL_PORT:-3306}
      - MYSQL_USER=${MYSQL_USER:-root}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-waGo}
      
      # Default Admin User
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      
      # Application Settings
      - SESSION_TIMEOUT=${SESSION_TIMEOUT:-24h}
      - MAX_SESSIONS=${MAX_SESSIONS:-10}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      
      # WhatsApp Configuration
      - WHATSAPP_DB_PATH=${WHATSAPP_DB_PATH}
      - AUTO_CONNECT=${AUTO_CONNECT:-true}
      
      # Security Settings
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-*}
      - RATE_LIMIT=${RATE_LIMIT:-100}
      
    volumes:
      # Database storage - maps to local whatsapp directory
      - ${DATA_DIR:-./whatsapp}:/app/data
      
      # WhatsApp session storage
      - ${WHATSAPP_DIR:-./whatsapp/sessions}:/app/sessions
      
      # Application logs
      - ${LOGS_DIR:-./whatsapp/logs}:/app/logs
      
      # Optional: Custom configuration
      - ${CONFIG_DIR:-./config}:/app/config:ro
      
      # .env file loaded via env_file above
      
    networks:
      - whatsapp-network
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # MySQL service (optional - only used when DATABASE_TYPE=mysql)
  mysql:
    image: mysql:8.0
    container_name: whatsapp-mysql
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD:-robioki}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-waGo}
      - MYSQL_USER=${MYSQL_USER:-root}
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - whatsapp-network
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_PASSWORD:-robioki}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

networks:
  whatsapp-network:
    driver: bridge
    name: whatsapp-network

volumes:
  mysql-data:

# Named volumes are defined but not used in favor of bind mounts
# Uncomment if you prefer named volumes over bind mounts
# volumes:
#   whatsapp-data:
#   whatsapp-sessions:
#   whatsapp-logs: