<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Multi-Session Manager</title>
    <script src="dist/bundle.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div id="app">
        <div class="min-h-screen">
            <!-- Header -->
            <header class="bg-green-600 text-white shadow-lg">
                <div class="container mx-auto px-4 py-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fab fa-whatsapp text-3xl mr-3"></i>
                            <h1 class="text-2xl font-bold">WhatsApp Multi-Session Manager</h1>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm">{{ sessions.length }} Sessions</span>
                            <span v-if="user" class="text-sm">Welcome, {{ user.username }}!</span>
                            <button @click="loadSessions" class="bg-green-700 hover:bg-green-800 px-3 py-1 rounded text-sm">
                                <i class="fas fa-sync-alt mr-1"></i>Refresh
                            </button>
                            <button @click="logout" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">
                                <i class="fas fa-sign-out-alt mr-1"></i>Logout
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <div class="container mx-auto px-4 py-8">
                <!-- Add Session Form -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-plus-circle mr-2 text-green-600"></i>
                        Add New WhatsApp Session
                    </h2>
                    <div class="flex flex-col md:flex-row gap-4">
                        <input 
                            v-model="newSession.phone" 
                            type="text" 
                            placeholder="Phone number (optional - will auto-generate if empty)"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        >
                        <input 
                            v-model="newSession.name" 
                            type="text" 
                            placeholder="Session name (optional)"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        >
                        <button 
                            @click="createSession"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition duration-200"
                        >
                            <i class="fas fa-plus mr-2"></i>Add Session
                        </button>
                    </div>
                    <div v-if="message" :class="messageClass" class="mt-4 p-3 rounded-lg">
                        {{ message }}
                    </div>
                </div>

                <!-- Sessions Grid -->
                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    <div 
                        v-for="session in sessions" 
                        :key="session.id"
                        class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition duration-200"
                    >
                        <!-- Session Header -->
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="font-semibold text-lg">{{ session.name || 'Unnamed' }}</h3>
                                    <p class="text-green-100 text-sm">ID: {{ session.phone }}</p>
                                    <p v-if="session.actual_phone" class="text-green-100 text-xs">Phone: {{ session.actual_phone }}</p>
                                </div>
                                <div class="text-right">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-circle text-xs mr-1" :class="session.connected ? 'text-green-300' : 'text-red-300'"></i>
                                        <span class="text-xs">{{ session.connected ? 'Connected' : 'Disconnected' }}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-user-check text-xs mr-1" :class="session.logged_in ? 'text-green-300' : 'text-gray-300'"></i>
                                        <span class="text-xs">{{ session.logged_in ? 'Logged In' : 'Not Logged In' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Session Actions -->
                        <div class="p-4">
                            <div class="flex flex-wrap gap-2">
                                <button 
                                    v-if="!session.logged_in"
                                    @click="showQRModal(session)"
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-medium transition duration-200"
                                >
                                    <i class="fas fa-qrcode mr-1"></i>Show QR
                                </button>
                                <button 
                                    v-if="session.logged_in"
                                    @click="logout(session.id)"
                                    class="flex-1 bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded text-sm font-medium transition duration-200"
                                >
                                    <i class="fas fa-sign-out-alt mr-1"></i>Logout
                                </button>
                                <button 
                                    v-if="session.logged_in"
                                    @click="showSendModal(session)"
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-medium transition duration-200"
                                >
                                    <i class="fas fa-paper-plane mr-1"></i>Send
                                </button>
                                <button 
                                    @click="deleteSession(session.id)"
                                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm font-medium transition duration-200"
                                >
                                    <i class="fas fa-trash mr-1"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div v-if="sessions.length === 0" class="text-center py-12">
                    <i class="fas fa-mobile-alt text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">No WhatsApp Sessions</h3>
                    <p class="text-gray-500">Add your first WhatsApp session to get started!</p>
                </div>
            </div>
        </div>

        <!-- Login Modal -->
        <div v-if="showLoginModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="text-center mb-6">
                    <i class="fab fa-whatsapp text-5xl text-green-600 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800">WhatsApp Manager</h2>
                    <p class="text-gray-600">{{ showRegisterForm ? 'Create Account' : 'Please Login' }}</p>
                </div>

                <!-- Login Form -->
                <form v-if="!showRegisterForm" @submit.prevent="login" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input 
                            v-model="loginForm.username" 
                            type="text" 
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            placeholder="Enter your username"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input 
                            v-model="loginForm.password" 
                            type="password" 
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            placeholder="Enter your password"
                        >
                    </div>
                    
                    <div v-if="authError" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        {{ authError }}
                    </div>
                    
                    <button 
                        type="submit"
                        :disabled="authLoading"
                        class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-medium py-2 px-4 rounded-lg transition duration-200"
                    >
                        <i v-if="authLoading" class="fas fa-spinner fa-spin mr-2"></i>
                        {{ authLoading ? 'Logging in...' : 'Login' }}
                    </button>
                    
                    <div class="text-center">
                        <button 
                            type="button"
                            @click="toggleAuthForm"
                            class="text-green-600 hover:text-green-700 text-sm"
                        >
                            Don't have an account? Register here
                        </button>
                    </div>
                </form>

                <!-- Register Form -->
                <form v-if="showRegisterForm" @submit.prevent="register" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input 
                            v-model="registerForm.username" 
                            type="text" 
                            required
                            minlength="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            placeholder="Choose a username (min 3 characters)"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input 
                            v-model="registerForm.password" 
                            type="password" 
                            required
                            minlength="6"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            placeholder="Choose a password (min 6 characters)"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                        <input 
                            v-model="registerForm.confirmPassword" 
                            type="password" 
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            placeholder="Confirm your password"
                        >
                    </div>
                    
                    <div v-if="authError" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        {{ authError }}
                    </div>
                    
                    <button 
                        type="submit"
                        :disabled="authLoading"
                        class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-medium py-2 px-4 rounded-lg transition duration-200"
                    >
                        <i v-if="authLoading" class="fas fa-spinner fa-spin mr-2"></i>
                        {{ authLoading ? 'Creating Account...' : 'Register' }}
                    </button>
                    
                    <div class="text-center">
                        <button 
                            type="button"
                            @click="toggleAuthForm"
                            class="text-green-600 hover:text-green-700 text-sm"
                        >
                            Already have an account? Login here
                        </button>
                    </div>
                </form>
                
                <div class="mt-6 pt-4 border-t border-gray-200 text-center text-sm text-gray-600">
                    <p>Default admin credentials:</p>
                    <p><strong>Username:</strong> admin</p>
                    <p><strong>Password:</strong> admin123</p>
                </div>
            </div>
        </div>

        <!-- QR Code Modal -->
        <div v-if="qrModal.show" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Scan QR Code</h3>
                    <button @click="closeQRModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="text-center">
                    <div v-if="qrModal.loading" class="py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">Generating QR Code...</p>
                    </div>
                    
                    <div v-else-if="qrModal.qrCode" class="space-y-4">
                        <div id="qrcode" class="flex justify-center"></div>
                        <p class="text-sm text-gray-600">
                            Scan this QR code with WhatsApp on your phone
                        </p>
                        <div v-if="qrModal.countdown > 0" class="text-sm text-orange-600">
                            Expires in {{ qrModal.countdown }} seconds
                        </div>
                    </div>
                    
                    <div v-else-if="qrModal.error" class="py-8 text-red-600">
                        <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                        <p>{{ qrModal.error }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Send Message Modal -->
        <div v-if="sendModal.show" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Send Message</h3>
                    <button @click="closeSendModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">To:</label>
                        <input 
                            v-model="sendModal.to" 
                            type="text" 
                            placeholder="6281234567890 (or with @s.whatsapp.net)"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Message:</label>
                        <textarea 
                            v-model="sendModal.message" 
                            placeholder="Type your message here..."
                            rows="4"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        ></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button 
                            @click="sendMessage"
                            :disabled="!sendModal.to || !sendModal.message"
                            class="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg font-medium transition duration-200"
                        >
                            <i class="fas fa-paper-plane mr-2"></i>Send Message
                        </button>
                        <button 
                            @click="closeSendModal"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    // Authentication
                    isAuthenticated: false,
                    showLoginModal: true,
                    user: null,
                    loginForm: {
                        username: '',
                        password: ''
                    },
                    registerForm: {
                        username: '',
                        password: '',
                        confirmPassword: ''
                    },
                    showRegisterForm: false,
                    authLoading: false,
                    authError: '',
                    
                    // Existing data
                    sessions: [],
                    newSession: {
                        phone: '',
                        name: ''
                    },
                    message: '',
                    messageClass: '',
                    qrModal: {
                        show: false,
                        session: null,
                        qrCode: '',
                        loading: false,
                        error: '',
                        countdown: 0,
                        countdownInterval: null,
                        ws: null
                    },
                    sendModal: {
                        show: false,
                        session: null,
                        to: '',
                        message: ''
                    }
                }
            },
            
            mounted() {
                // Check if QRCode library is loaded
                console.log('QRCode available:', typeof QRCode !== 'undefined');
                if (typeof QRCode === 'undefined') {
                    console.error('QRCode library not loaded - retrying in 1 second');
                    setTimeout(() => {
                        console.log('QRCode available after retry:', typeof QRCode !== 'undefined');
                    }, 1000);
                }
                
                // Check for existing authentication
                this.checkAuthentication();
            },
            
            methods: {
                // Authentication methods
                checkAuthentication() {
                    const token = localStorage.getItem('auth_token');
                    const user = localStorage.getItem('user_data');
                    
                    if (token && user) {
                        this.isAuthenticated = true;
                        this.user = JSON.parse(user);
                        this.showLoginModal = false;
                        this.setupAxiosInterceptors();
                        this.loadSessions();
                        // Auto refresh every 5 seconds
                        setInterval(this.loadSessions, 5000);
                    } else {
                        this.showLoginModal = true;
                    }
                },
                
                setupAxiosInterceptors() {
                    const token = localStorage.getItem('auth_token');
                    if (token) {
                        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                    }
                    
                    // Add response interceptor to handle 401 errors
                    axios.interceptors.response.use(
                        response => response,
                        error => {
                            if (error.response && error.response.status === 401) {
                                this.logout();
                            }
                            return Promise.reject(error);
                        }
                    );
                },
                
                async login() {
                    if (!this.loginForm.username || !this.loginForm.password) {
                        this.authError = 'Please enter username and password';
                        return;
                    }
                    
                    this.authLoading = true;
                    this.authError = '';
                    
                    try {
                        const response = await axios.post('/api/login', {
                            username: this.loginForm.username,
                            password: this.loginForm.password
                        });
                        
                        if (response.data.success) {
                            localStorage.setItem('auth_token', response.data.token);
                            localStorage.setItem('user_data', JSON.stringify(response.data.user));
                            
                            this.isAuthenticated = true;
                            this.user = response.data.user;
                            this.showLoginModal = false;
                            this.loginForm = { username: '', password: '' };
                            
                            this.setupAxiosInterceptors();
                            this.loadSessions();
                            // Auto refresh every 5 seconds
                            setInterval(this.loadSessions, 5000);
                        }
                    } catch (error) {
                        this.authError = error.response?.data || 'Login failed';
                    } finally {
                        this.authLoading = false;
                    }
                },
                
                async register() {
                    if (!this.registerForm.username || !this.registerForm.password) {
                        this.authError = 'Please fill in all fields';
                        return;
                    }
                    
                    if (this.registerForm.password !== this.registerForm.confirmPassword) {
                        this.authError = 'Passwords do not match';
                        return;
                    }
                    
                    if (this.registerForm.password.length < 6) {
                        this.authError = 'Password must be at least 6 characters';
                        return;
                    }
                    
                    this.authLoading = true;
                    this.authError = '';
                    
                    try {
                        const response = await axios.post('/api/register', {
                            username: this.registerForm.username,
                            password: this.registerForm.password
                        });
                        
                        if (response.data.success) {
                            this.showRegisterForm = false;
                            this.registerForm = { username: '', password: '', confirmPassword: '' };
                            this.authError = '';
                            this.showMessage('Registration successful! Please login.', 'success');
                        }
                    } catch (error) {
                        this.authError = error.response?.data || 'Registration failed';
                    } finally {
                        this.authLoading = false;
                    }
                },
                
                logout() {
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user_data');
                    delete axios.defaults.headers.common['Authorization'];
                    
                    this.isAuthenticated = false;
                    this.user = null;
                    this.showLoginModal = true;
                    this.sessions = [];
                },
                
                toggleAuthForm() {
                    this.showRegisterForm = !this.showRegisterForm;
                    this.authError = '';
                    this.loginForm = { username: '', password: '' };
                    this.registerForm = { username: '', password: '', confirmPassword: '' };
                },

                async loadSessions() {
                    if (!this.isAuthenticated) return;
                    
                    try {
                        const response = await axios.get('/api/sessions');
                        this.sessions = response.data.data || [];
                    } catch (error) {
                        if (error.response?.status === 401) {
                            this.logout();
                        } else {
                            console.error('Error loading sessions:', error);
                        }
                    }
                },
                
                async createSession() {
                    try {
                        const response = await axios.post('/api/sessions', {
                            phone: this.newSession.phone || "", // Allow empty phone for auto-generation
                            name: this.newSession.name
                        });
                        
                        if (response.data.success) {
                            this.showMessage('Session created successfully!', 'success');
                            this.newSession = { phone: '', name: '' };
                            await this.loadSessions();
                        } else {
                            this.showMessage(response.data.error || 'Failed to create session', 'error');
                        }
                    } catch (error) {
                        this.showMessage('Error creating session: ' + error.message, 'error');
                    }
                },
                
                async deleteSession(id) {
                    if (!confirm('Are you sure you want to delete this session?')) return;
                    
                    try {
                        await axios.delete(`/api/sessions/${id}`);
                        this.showMessage('Session deleted successfully!', 'success');
                        await this.loadSessions();
                    } catch (error) {
                        this.showMessage('Error deleting session: ' + error.message, 'error');
                    }
                },
                
                async logout(id) {
                    try {
                        await axios.post(`/api/sessions/${id}/logout`);
                        this.showMessage('Logged out successfully!', 'success');
                        await this.loadSessions();
                    } catch (error) {
                        this.showMessage('Error logging out: ' + error.message, 'error');
                    }
                },
                
                showQRModal(session) {
                    this.qrModal.show = true;
                    this.qrModal.session = session;
                    this.qrModal.loading = true;
                    this.qrModal.error = '';
                    this.qrModal.qrCode = '';
                    
                    // Connect WebSocket for real-time QR updates
                    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const token = localStorage.getItem('auth_token');
                    const wsUrl = `${wsProtocol}//${window.location.host}/api/ws/${session.id}?token=${encodeURIComponent(token)}`;
                    
                    this.qrModal.ws = new WebSocket(wsUrl);
                    
                    this.qrModal.ws.onmessage = (event) => {
                        console.log('WebSocket message received:', event.data);
                        const data = JSON.parse(event.data);
                        console.log('Parsed WebSocket data:', data);
                        
                        if (data.type === 'qr') {
                            console.log('QR code received, length:', data.data.qr.length);
                            this.qrModal.loading = false;
                            this.qrModal.qrCode = data.data.qr;
                            this.generateQRCode(data.data.qr);
                            
                            // Start countdown
                            this.qrModal.countdown = Math.floor(data.data.timeout / 1000000000); // Convert from nanoseconds
                            this.startCountdown();
                        } else if (data.type === 'success') {
                            console.log('Login success received');
                            this.qrModal.loading = false;
                            this.closeQRModal();
                            this.showMessage('Login successful!', 'success');
                            this.loadSessions();
                        } else if (data.type === 'error') {
                            console.log('Error received:', data.error);
                            this.qrModal.loading = false;
                            this.qrModal.error = data.error;
                        } else {
                            console.log('Other event received:', data.type, data);
                        }
                    };
                    
                    this.qrModal.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.qrModal.loading = false;
                        this.qrModal.error = 'Connection failed. Please try again.';
                    };
                    
                    this.qrModal.ws.onclose = (event) => {
                        console.log('WebSocket closed:', event);
                        if (this.qrModal.loading) {
                            this.qrModal.loading = false;
                            this.qrModal.error = 'Connection closed unexpectedly';
                        }
                    };
                },
                
                closeQRModal() {
                    this.qrModal.show = false;
                    if (this.qrModal.ws) {
                        this.qrModal.ws.close();
                        this.qrModal.ws = null;
                    }
                    if (this.qrModal.countdownInterval) {
                        clearInterval(this.qrModal.countdownInterval);
                        this.qrModal.countdownInterval = null;
                    }
                    
                    // Reset modal state
                    this.qrModal.session = null;
                    this.qrModal.qrCode = '';
                    this.qrModal.loading = false;
                    this.qrModal.error = '';
                    this.qrModal.countdown = 0;
                },
                
                generateQRCode(qrString) {
                    const tryGenerateQR = () => {
                        this.$nextTick(() => {
                            const qrElement = document.getElementById('qrcode');
                            if (qrElement) {
                                qrElement.innerHTML = '';
                                
                                // Check if QRCode library is available
                                if (typeof QRCode === 'undefined') {
                                    console.error('QRCode library not loaded, showing fallback');
                                    // Show the QR code as text if library not available
                                    qrElement.innerHTML = `
                                        <div style="text-align: center; padding: 20px;">
                                            <p style="margin-bottom: 10px; font-weight: bold;">QR Code (Library loading...)</p>
                                            <textarea readonly style="width: 100%; height: 100px; font-family: monospace; font-size: 10px;">${qrString}</textarea>
                                            <p style="margin-top: 10px; font-size: 12px; color: #666;">Copy this text to your phone's WhatsApp Web scanner</p>
                                        </div>
                                    `;
                                    return;
                                }
                                
                                // Create a canvas element for QR code
                                const canvas = document.createElement('canvas');
                                
                                QRCode.toCanvas(canvas, qrString, {
                                    width: 256,
                                    margin: 2,
                                    color: {
                                        dark: '#000000',
                                        light: '#FFFFFF'
                                    }
                                }, (error) => {
                                    if (error) {
                                        console.error('QR Code generation error:', error);
                                        this.qrModal.error = 'Failed to generate QR code: ' + error;
                                    } else {
                                        // Successfully generated, append canvas to div
                                        qrElement.appendChild(canvas);
                                        console.log('QR code generated successfully');
                                    }
                                });
                            } else {
                                console.error('QR element not found');
                                this.qrModal.error = 'QR display element not found';
                            }
                        });
                    };
                    
                    // Try immediately, if QRCode not available, wait and retry
                    if (typeof QRCode === 'undefined') {
                        console.log('QRCode library not ready, waiting 1 second...');
                        setTimeout(() => {
                            tryGenerateQR();
                        }, 1000);
                    } else {
                        tryGenerateQR();
                    }
                },
                
                startCountdown() {
                    this.qrModal.countdownInterval = setInterval(() => {
                        this.qrModal.countdown--;
                        if (this.qrModal.countdown <= 0) {
                            clearInterval(this.qrModal.countdownInterval);
                            this.qrModal.error = 'QR code expired';
                        }
                    }, 1000);
                },
                
                showSendModal(session) {
                    this.sendModal.show = true;
                    this.sendModal.session = session;
                    this.sendModal.to = '';
                    this.sendModal.message = '';
                },
                
                closeSendModal() {
                    this.sendModal.show = false;
                    this.sendModal.session = null;
                    this.sendModal.to = '';
                    this.sendModal.message = '';
                },
                
                async sendMessage() {
                    if (!this.sendModal.to || !this.sendModal.message) return;
                    
                    try {
                        const response = await axios.post(`/api/sessions/${this.sendModal.session.id}/send`, {
                            to: this.sendModal.to,
                            message: this.sendModal.message
                        });
                        
                        if (response.data.success) {
                            this.showMessage('Message sent successfully!', 'success');
                            this.closeSendModal();
                        } else {
                            this.showMessage('Failed to send message', 'error');
                        }
                    } catch (error) {
                        this.showMessage('Error sending message: ' + error.message, 'error');
                    }
                },
                
                showMessage(text, type) {
                    this.message = text;
                    this.messageClass = type === 'error' 
                        ? 'bg-red-100 border border-red-400 text-red-700' 
                        : 'bg-green-100 border border-green-400 text-green-700';
                    
                    setTimeout(() => {
                        this.message = '';
                    }, 5000);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>